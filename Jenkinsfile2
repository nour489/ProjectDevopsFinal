pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                script {
                    // Checkout the code from your SCM
                    checkout scm
                    // Run Maven package
                    sh 'mvn clean package'
                }
            }
        }
        stage('Archive Artifacts') {
            steps {
                // Archive the JAR file
                archiveArtifacts artifacts: 'target/tpAchatProject-1.0.jar', fingerprint: true
            }
        }
        stage('Nexus Deployment') {
            steps {
                script {


                    // Deploy to Nexus
                    nexusArtifactUploader artifacts: [
                        [
                            artifactId: 'tpAchatProject', // Use the artifactId from pom.xml
                            classifier: '',
                            file: 'target/tpAchatProject-1.0.jar', // Specify the correct path
                            type: 'jar'
                        ]
                    ],
                    credentialsId: 'nexus-auth', // Ensure this ID matches your Jenkins credentials
                    groupId: 'com.esprit.examen', // Use the groupId from pom.xml
                    nexusUrl: '192.168.50.4:8081', // Ensure http:// is included
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    repository: 'projet-spring', // Use the repository defined in your pom.xml
                    version: "1.0" // Use the version defined in your pom.xml
                }
            }
        }
        stage('Docker Image Build') {
            steps {
                script {
                    // Construire l'image Docker avec un nom en minuscules
                    sh "docker build -t pipeline_de_gestion_des_artefacts:v1.${BUILD_ID} ."
                    // Taguer l'image avec le nom d'utilisateur Docker Hub
                    sh "docker tag pipeline_de_gestion_des_artefacts:v1.${BUILD_ID} khouloudzograni/pipeline_de_gestion_des_artefacts:v1.${BUILD_ID}"
                    // Taguer l'image comme la version latest
                    sh "docker tag pipeline_de_gestion_des_artefacts:v1.${BUILD_ID} khouloudzograni/pipeline_de_gestion_des_artefacts:latest"

                }
            }
        }
        stage("Docker Hub") {
            steps{
                script{
                withCredentials([string(credentialsId: 'git_creds', variable: 'docker_hub_cred')]) {
                    sh 'docker login  -u khouloudzograni -p ${docker_hub_cred}'
                    sh 'docker image push khouloudzograni/pipeline_de_gestion_des_artefacts:v1.${BUILD_ID}'
                    sh 'docker image push khouloudzograni/pipeline_de_gestion_des_artefacts:latest'

                }
                }
            }
        }
    }
}
